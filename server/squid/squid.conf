#
# Proxy clients
#

acl localnet src 10.10.0.0/16
acl localnet src 2406:3400:217:e030::/60
acl localnet src fe80::/10
acl to_localnet dst 10.10.0.0/16
acl to_localnet dst 2406:3400:217:e030::/60
acl to_localnet dst fe80::/10

acl libvirt_default src 192.168.122.0/24
acl to_libvirt_default dst 192.168.122.0/24

acl proxy_clients any-of localnet libvirt_default localhost
acl to_lan any-of to_localnet to_libvirt_default

acl no_internet src 10.10.10.12 # GAZOO
acl no_internet src 10.10.10.14 # Epson "Network Interface Unit"

#
# HTTP particulars
#

acl ssl_ports port 443
acl ssl_ports port 2083      # cPanel
acl ssl_ports port 2087      # WHM
acl ssl_ports port 5228-5230 # Google Cloud Messaging
acl ssl_ports port 10000     # Webmin
acl ssl_ports port 20000     # Virtualmin

acl safe_ports port 80
acl safe_ports port 21
acl safe_ports port 443
acl safe_ports port 70
acl safe_ports port 210
acl safe_ports port 1025-65535
acl safe_ports port 280
acl safe_ports port 488
acl safe_ports port 591
acl safe_ports port 777

acl PURGE method PURGE

acl localport_accel localport 80
acl localport_no_filter localport 3127

acl to_null dst :: 0.0.0.0
acl very_safe_ports port 80 443

#
# Serviced by local lighttpd
#

acl local_mirror dstdomain .mirror

acl local_vhost dstdomain .lan
acl local_vhost dstdomain .repo
acl local_vhost dstdomain .doo.linacreative.com
acl local_vhost dstdomain wpad wpad.linacreative.com

acl to_lighttpd any-of local_mirror local_vhost

#
# Homebrew reverse proxy
#

acl homebrew_mirror dstdomain brew.mirror
acl homebrew_ghcr url_regex ^https?://ghcr\.io/v2/homebrew/
acl homebrew_manifest urlpath_regex ^/manifests/.

acl cache_without_query url_regex ^https?://pkg-containers\.githubusercontent\.com/.+/blobs/
acl cache_without_query url_regex ^https?://objects\.githubusercontent\.com/

#
# For "no_internet" clients
#

acl crl dstdomain .digicert.com                                 # "CRL and OCSP checks to the issuing certificate authorities"
acl crl dstdomain ctldl.windowsupdate.com                       # "Used to download certificates that are publicly known to be fraudulent"
acl crl dstdomain nav.smartscreen.microsoft.com                 # "Windows Defender"
acl crl_url url_regex ^http://www\.microsoft\.com/pkiops/certs/ # "CRL and OCSP checks to the issuing certificate authorities"

acl private_cloud dstdomain cloud.arms.to

acl essential any-of crl crl_url private_cloud

#
# Operating system updates
#

acl updates dstdomain .dl.delivery.mp.microsoft.com
acl updates dstdomain .download.windowsupdate.com
acl updates dstdomain officecdn.microsoft.com
acl updates dstdomain officecdn.microsoft.com.edgesuite.net
acl updates dstdomain swcdn.apple.com

#
# CONNECT allowed on ports other than "ssl_ports"
#

acl connect_hosts dstdomain .akamaihd.net
acl connect_hosts dstdomain .webconsole.linode.com
acl connect_hosts dstdomain gs.apple.com
acl connect_hosts_re dstdom_regex \<speedtest\>
acl connect_hosts_re dstdom_regex (\.|^)steam(community|content|games|powered|static|usercontent)\.com$

acl connect_allowed any-of ssl_ports connect_hosts connect_hosts_re

#
# Ad-tolerant devices
#

acl privileged_hardware arp 1e:3a:d6:eb:4b:fa # Susan's iPad

acl ssl_hosts_privileged dstdomain gamestate.bigfishgames.com # Fairway Solitaire

#
# Game downloads (throttled)
#

acl gaming dstdomain .dl.playstation.net
acl gaming dstdomain .epicgames.com
acl gaming dstdomain .loris-e.llnwd.net
acl gaming dstdomain .unrealengine.com
acl gaming dstdomain epicgames-download1.akamaized.net
acl gaming_re dstdom_regex (\.|^)steam(community|content|games|powered|static|usercontent)\.com$

#
# notracking (see https://github.com/notracking)
#

acl blocked dstdomain "/opt/lk-settings/server/squid/notracking.dstdomain"
acl unblocked dstdomain "/opt/lk-settings/server/squid/unblock.dstdomain"
acl unblocked_privileged dstdomain "/opt/lk-settings/server/squid/unblock-privileged.dstdomain"

http_access deny !safe_ports

http_access allow localhost manager
http_access deny manager
http_access allow localhost PURGE
http_access deny PURGE

# Don't punish users for the sins of sysadmins, e.g. AAAA records like this:
#
#     cottonon.com.           1712    IN      AAAA    ::
#
# Without the next line, requests that resolve to the NULL IPv6 address (::)
# would be rejected by "deny to_localhost" with no IPv4 attempt. It wouldn't be
# acceptable to enable `dns_v4_first`, so allow these requests to resolve at the
# TCP level.
#
# IMPORTANT: THERE MUST BE NOTHING LISTENING TO LOCALHOST:80 OR LOCALHOST:443,
# OR PRIVILEGED DATA MAY BE EXPOSED (AND THE FIX WON'T WORK).
#
# Listening to ports 80 and 443 on interfaces other than localhost is okay.
http_access allow to_null very_safe_ports proxy_clients
http_access deny to_localhost

http_access allow no_internet to_lan
http_access allow no_internet essential
http_access deny no_internet

http_access allow localport_no_filter proxy_clients

http_access deny blocked !unblocked !privileged_hardware
http_access deny blocked !unblocked !unblocked_privileged

http_access allow CONNECT connect_allowed
http_access allow CONNECT ssl_hosts_privileged privileged_hardware
http_access deny CONNECT

http_access allow proxy_clients
http_access deny all

http_port 3127
http_port 3128
http_port 3129 intercept
http_port 80 accel defaultsite=doo.linacreative.com ignore-cc

cache_peer 127.0.0.1 parent 81 0 originserver name=lighttpd no-digest no-netdb-exchange
cache_peer_access lighttpd allow to_lighttpd
cache_peer_access lighttpd deny all

cache_replacement_policy heap LFUDA
maximum_object_size 20 GB
# 90% of 468355
cache_dir aufs /cache/squid 421520 16 256

# added:
# - %lp (local port)
logformat squid_custom %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt %lp

access_log stdio:/var/log/squid/access.log squid_custom #
cache_store_log stdio:/var/log/squid/store.log          #
logfile_rotate 0                                        #
strip_query_terms off                                   #
#debug_options ALL,1 33,2 28,9                          # For http_access debugging
coredump_dir /var/cache/squid                           #

url_rewrite_program /opt/lk-settings/server/squid/url_rewrite.sh
url_rewrite_children 20 startup=1 idle=2
url_rewrite_access allow homebrew_mirror
url_rewrite_access deny all
# client IP, request method
url_rewrite_extras "%>a %>rm"

store_id_program /opt/lk-settings/server/squid/store_id.sh
store_id_children 20 startup=1 idle=2
store_id_access allow cache_without_query
store_id_access deny all
store_id_extras "%>a %>rm"

cache deny local_vhost
cache deny homebrew_mirror
cache deny gaming
cache deny gaming_re

#
# Arch Linux
#
refresh_pattern \.pkg\.tar\.						129600	100%	129600	reload-into-ims
refresh_pattern \<arch\>.*\.db(\.tar(\.(gz|bz2|xz|Z))?)?(\.sig)?$	0	0%	0

#
# Ubuntu, Debian, etc.
#
refresh_pattern \.deb$							129600	100%	129600	reload-into-ims

#
# Install media, cloud images (and their checksums)
#
refresh_pattern -i \.(img|iso|esd)$					1440	20%	129600	reload-into-ims
refresh_pattern -i ^http://cloud-images\..*/SHA256SUMS(\.gpg)?$		1440	20%	129600	reload-into-ims

#
# Updates
#
refresh_pattern -i ^http://[^/]*dl\.delivery\.mp\.microsoft\.com(/.*)?/([^/]+\.(cab|exe|ms[i|u]|zip)|[^/.]+)$		129600	100%	129600	reload-into-ims
refresh_pattern -i ^http://[^/]*download\.windowsupdate\.com(/.*)?/([^/]+\.(cab|exe|ms[i|u]|zip)|[^/.]+)$		129600	100%	129600	reload-into-ims
refresh_pattern -i ^http://officecdn\.microsoft\.com(\.edgesuite\.net)?(/.*)?/([^/]+\.(cab|exe|ms[i|u]|zip)|[^/.]+)$	129600	100%	129600	reload-into-ims
refresh_pattern -i ^http://(([^/]+\.)?cdn-apple|swcdn\.apple)\.com/.*\.(pkg|zip)$					129600	100%	129600	reload-into-ims

#
# Defaults
#
refresh_pattern ^ftp:			1440	20%	10080
refresh_pattern ^gopher:		1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?)	0	0%	0
refresh_pattern .			0	20%	4320

quick_abort_min -1
range_offset_limit 4 GB updates

reply_header_access Content-Type deny homebrew_mirror homebrew_manifest
reply_header_add Content-Type "application/vnd.oci.image.index.v1+json" homebrew_mirror homebrew_manifest

request_header_add Authorization "Bearer QQ==" homebrew_ghcr localport_accel

shutdown_lifetime 1 second

# Game downloads: 6.5M/s after first 390M
delay_pools 1
delay_class 1 1
delay_access 1 allow gaming
delay_access 1 allow gaming_re
delay_access 1 deny all
delay_parameters 1 6815744/408944640

always_direct allow localport_accel !to_lighttpd proxy_clients
always_direct deny all

deny_info TCP_RESET no_internet

dns_nameservers 127.0.0.1 ::1
hosts_file /opt/lk-settings/server/dnsmasq/dnsmasq.d/hosts

cachemgr_passwd none all
