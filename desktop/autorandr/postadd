#!/bin/bash

set -euo pipefail

function maybe_setvcp() {
    local VALUE
    VALUE=$(sudo ddcutil getvcp -t "$1" "${@:3}" | awk '{print $4}') &&
        [ "$VALUE" = "$2" ] &&
        echo "${0##*/}: VCP $1 is already $2" >&2 ||
        { echo "${0##*/}: Setting VCP $1 to $2" >&2 && sudo ddcutil setvcp "$@" && CHANGED=1; }
}

{ STATUS=$(systemctl is-system-running) ||
    [[ ! $STATUS =~ ^(initializing|starting)$ ]]; } &&
    awk '$1<60{exit 1}' /proc/uptime || {
    echo "${0##*/}: System is starting, exiting" >&2
    exit
}
echo "${0##*/}: System is $STATUS, continuing" >&2

CHANGED=

case "$HOSTNAME" in
bamm-bamm)
    # Samsung LU28R55 -> HDMI1
    maybe_setvcp x60 x05 \
        --edid 00FFFFFFFFFFFF004C2D1710425642302E1E0103803F24782AC8B5AD50449E250F5054BFEF80714F810081C081809500A9C0B300010108E80030F2705A80B0588A0078682100001E000000FD00324B1E873C000A202020202020000000FC004C5532385235350A2020202020000000FF00484E4D4E4230313131340A2020019C || true

    # AOC U2790VQ -> HDMI 1
    maybe_setvcp x60 x11 \
        --edid 00FFFFFFFFFFFF0005E39027182C0000041D0103803C22782A67A1A5554DA2270E5054BFEF00D1C0B30095008180814081C0010101014DD000A0F0703E803020350055502100001AA36600A0F0701F803020350055502100001A000000FC005532373930420A202020202020000000FD0017501EA03C000A2020202020200181 || true

    ;;
esac

[ -z "$CHANGED" ] ||
    sleep ${DDCUTIL_SLEEP:-2}
